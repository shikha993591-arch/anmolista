<!DOCTYPE html>
<html>
<head>
<title>Chat</title>
<style>
body{margin:0;background:#111;color:white;font-family:Arial}
#msgs{height:80vh;overflow:auto;padding:10px}
.me{background:#4caf50;margin:5px;padding:8px;border-radius:8px;max-width:70%;margin-left:auto}
.other{background:#333;margin:5px;padding:8px;border-radius:8px;max-width:70%}
#box{display:flex}
input{flex:1;padding:10px}
button{padding:10px}
</style>
</head>
<body>

<div id="msgs"></div>
<div id="box">
<input id="msg">
<button onclick="send()">Send</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBpF3Q1ESL76ywrp2_OVOoOJiFOv322z5M",
  authDomain:"anmolista.firebaseapp.com",
  projectId:"anmolista"
});
const auth=firebase.auth();
const db=firebase.firestore();

const uid=new URLSearchParams(location.search).get("uid");

auth.onAuthStateChanged(u=>{
  db.collection("chats").doc(chatId()).collection("msgs")
  .orderBy("time")
  .onSnapshot(s=>{
    msgs.innerHTML="";
    s.forEach(d=>{
      msgs.innerHTML+=
        `<div class="${d.data().from==u.uid?'me':'other'}">
          ${d.data().text}
        </div>`;
    });
  });
});

function chatId(){
  return [auth.currentUser.uid,uid].sort().join("_");
}

function send(){
  db.collection("chats").doc(chatId()).collection("msgs").add({
    text:msg.value,
    from:auth.currentUser.uid,
    time:new Date()
  });
  msg.value="";
}
</script>
</body>
</html>
